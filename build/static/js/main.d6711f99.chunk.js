(this.webpackJsonpclownchat=this.webpackJsonpclownchat||[]).push([[0],{141:function(e,t,a){e.exports=a(285)},284:function(e,t,a){},285:function(e,t,a){"use strict";a.r(t);var s=a(1),n=a.n(s),r=a(7),o=a.n(r),c=a(35),l=a(21),i=a(129);a(150);var m=a(55);const p=(e,t)=>Object(m.a)(Object(m.a)({},e),t),h={token:null,username:null,error:null,loading:!1};var u=(e=h,t)=>{switch(t.type){case"AUTH_START":return((e,t)=>p(e,{error:null,loading:!0}))(e);case"AUTH_SUCCESS":return((e,t)=>p(e,{token:t.token,username:t.username,error:null,loading:!1}))(e,t);case"AUTH_FAIL":return((e,t)=>p(e,{error:t.error,loading:!1}))(e,t);case"AUTH_LOGOUT":return((e,t)=>p(e,{token:null,username:null}))(e);default:return e}};const d={showAddChatPopup:!1};var g=(e=d,t)=>{switch(t.type){case"OPEN_ADD_CHAT_POPUP":return((e,t)=>p(e,{showAddChatPopup:!0}))(e);case"CLOSE_ADD_CHAT_POPUP":return((e,t)=>p(e,{showAddChatPopup:!1}))(e);default:return e}};const E={messages:[],chats:[]};var f=(e=E,t)=>{switch(t.type){case"ADD_MESSAGE":return((e,t)=>p(e,{messages:[...e.messages,t.message]}))(e,t);case"SET_MESSAGES":return((e,t)=>p(e,{messages:t.messages.reverse()}))(e,t);case"GET_CHATS_SUCCESS":return((e,t)=>p(e,{chats:t.chats}))(e,t);default:return e}},S=a(290),w=a(130);var C=e=>e.children;let k="https://clownchat.herokuapp.com",v="wss://clownchat.herokuapp.com";class b{static getInstance(){return b.instance||(b.instance=new b),b.instance}constructor(){this.callbacks={},this.socketRef=null}connect(e){const t="".concat(v,"/ws/chat/").concat(e,"/");this.socketRef=new WebSocket(t),this.socketRef.onopen=()=>{console.log("WebSocket open")},this.socketRef.onmessage=e=>{this.socketNewMessage(e.data)},this.socketRef.onerror=e=>{console.log(e.message)},this.socketRef.onclose=()=>{console.log("WebSocket closed let's reopen"),this.connect()}}disconnect(){this.socketRef.close()}socketNewMessage(e){const t=JSON.parse(e),a=t.command;0!==Object.keys(this.callbacks).length&&("messages"===a&&this.callbacks[a](t.messages),"new_message"===a&&this.callbacks[a](t.message))}fetchMessages(e,t){this.sendMessage({command:"fetch_messages",username:e,chatId:t})}newChatMessage(e){this.sendMessage({command:"new_message",from:e.from,message:e.content,chatId:e.chatId})}addCallbacks(e,t){this.callbacks.messages=e,this.callbacks.new_message=t}sendMessage(e){try{this.socketRef.send(JSON.stringify(Object(m.a)({},e)))}catch(t){console.log(t.message)}}state(){return this.socketRef.readyState}}b.instance=null;var y=b.getInstance();class T extends n.a.Component{initialiseChat(){this.waitForSocketConnection(()=>{y.fetchMessages(this.props.username,this.props.match.params.chatID)}),y.connect(this.props.match.params.chatID)}constructor(e){super(e),this.state={message:""},this.messageChangeHandler=e=>{this.setState({message:e.target.value})},this.sendMessageHandler=e=>{e.preventDefault();const t={from:this.props.username,content:this.state.message,chatId:this.props.match.params.chatID};y.newChatMessage(t),this.setState({message:""})},this.renderTimestamp=e=>{let t="";const a=Math.round(((new Date).getTime()-new Date(e).getTime())/6e4);return t=a<1?"just now...":a<60&&a>1?"".concat(a," minutes ago"):a<1440&&a>60?"".concat(Math.round(a/60)," hours ago"):a<44640&&a>1440?"".concat(Math.round(a/1440)," days ago"):"".concat(new Date(e)),t},this.renderMessages=e=>{const t=this.props.username;return e.map((e,a,s)=>n.a.createElement("li",{key:e.id,style:{marginBottom:s.length-1===a?"300px":"15px"},className:e.author===t?"sent":"replies"},n.a.createElement("img",{src:"http://emilcarlsson.se/assets/mikeross.png",alt:"profile-pic"}),n.a.createElement("p",null,e.content,n.a.createElement("br",null),n.a.createElement("small",null,this.renderTimestamp(e.timestamp)))))},this.scrollToBottom=()=>{this.messagesEnd.scrollIntoView({behavior:"smooth"})},this.initialiseChat()}waitForSocketConnection(e){const t=this;setTimeout((function(){if(1===y.state())return console.log("Connection is made"),void e();console.log("wait for connection..."),t.waitForSocketConnection(e)}),100)}componentDidMount(){this.scrollToBottom()}componentDidUpdate(){this.scrollToBottom()}componentWillReceiveProps(e){this.props.match.params.chatID!==e.match.params.chatID&&(y.disconnect(),this.waitForSocketConnection(()=>{y.fetchMessages(this.props.username,e.match.params.chatID)}),y.connect(e.match.params.chatID))}render(){return n.a.createElement(C,null,n.a.createElement("div",{className:"messages"},n.a.createElement("ul",{id:"chat-log"},this.props.messages&&this.renderMessages(this.props.messages),n.a.createElement("div",{style:{float:"left",clear:"both"},ref:e=>{this.messagesEnd=e}}))),n.a.createElement("div",{className:"message-input"},n.a.createElement("form",{onSubmit:this.sendMessageHandler},n.a.createElement("div",{className:"wrap"},n.a.createElement("input",{onChange:this.messageChangeHandler,value:this.state.message,required:!0,id:"chat-message-input",type:"text",placeholder:"Write your message..."}),n.a.createElement("i",{className:"fa fa-paperclip attachment","aria-hidden":"true"}),n.a.createElement("button",{id:"chat-message-submit",className:"submit"},n.a.createElement("i",{className:"fa fa-paper-plane","aria-hidden":"true"}))))))}}var A=Object(l.b)(e=>({username:e.auth.username,messages:e.message.messages}))(T);var D=()=>n.a.createElement(C,null,n.a.createElement(w.a,{exact:!0,path:"/:chatID/",component:A})),N=a(17),_=a(286),O=a(18),P=a.n(O);const I=(e,t)=>({type:"AUTH_SUCCESS",token:t,username:e}),M=e=>({type:"AUTH_FAIL",error:e}),U=()=>(localStorage.removeItem("token"),localStorage.removeItem("username"),localStorage.removeItem("expirationDate"),{type:"AUTH_LOGOUT"}),F=e=>t=>{setTimeout(()=>{t(U())},1e3*e)},x=(e,t)=>a=>{P.a.defaults.xsrfHeaderName="X-CSRFTOKEN",P.a.defaults.xsrfCookieName="csrftoken",P.a.defaults.headers={"Content-Type":"application/json",Authorization:"Token ".concat(t)},P.a.get("".concat(k,"/chat/?username=").concat(e)).then(e=>a({type:"GET_CHATS_SUCCESS",chats:e.data}))};var H=a(292);var R=e=>n.a.createElement(H.a,{to:"".concat(e.chatURL),style:{color:"#fff"}},n.a.createElement("li",{className:"contact"},n.a.createElement("div",{className:"wrap"},n.a.createElement("span",{className:"contact-status ".concat(e.status)}),n.a.createElement("img",{src:e.picURL,alt:""}),n.a.createElement("div",{className:"meta"},n.a.createElement("p",{className:"name"},e.name)))));const j=n.a.createElement(N.a,{type:"loading",style:{fontSize:24},spin:!0});class L extends n.a.Component{constructor(...e){super(...e),this.state={loginForm:!0},this.changeForm=()=>{this.setState({loginForm:!this.state.loginForm})},this.authenticate=e=>{e.preventDefault(),this.state.loginForm?this.props.login(e.target.username.value,e.target.password.value):this.props.signup(e.target.username.value,e.target.email.value,e.target.password.value,e.target.password2.value)}}waitForAuthDetails(){const e=this;setTimeout((function(){null===e.props.token||void 0===e.props.token?(console.log("waiting for authentication details..."),e.waitForAuthDetails()):e.props.getUserChats(e.props.username,e.props.token)}),100)}componentDidMount(){this.waitForAuthDetails()}openAddChatPopup(){this.props.addChat()}render(){let e=this.props.chats.map(e=>n.a.createElement(R,{key:e.id,name:"Harvey Specter",picURL:"http://emilcarlsson.se/assets/louislitt.png",status:"busy",chatURL:"/".concat(e.id)}));return n.a.createElement("div",{id:"sidepanel"},n.a.createElement("div",{id:"profile"},n.a.createElement("div",{className:"wrap"},n.a.createElement("img",{id:"profile-img",src:"http://emilcarlsson.se/assets/mikeross.png",className:"online",alt:""}),n.a.createElement("p",null,"Mike Ross"),n.a.createElement("i",{className:"fa fa-chevron-down expand-button","aria-hidden":"true"}),n.a.createElement("div",{id:"status-options"},n.a.createElement("ul",null,n.a.createElement("li",{id:"status-online",className:"active"},n.a.createElement("span",{className:"status-circle"})," ",n.a.createElement("p",null,"Online")),n.a.createElement("li",{id:"status-away"},n.a.createElement("span",{className:"status-circle"})," ",n.a.createElement("p",null,"Away")),n.a.createElement("li",{id:"status-busy"},n.a.createElement("span",{className:"status-circle"})," ",n.a.createElement("p",null,"Busy")),n.a.createElement("li",{id:"status-offline"},n.a.createElement("span",{className:"status-circle"})," ",n.a.createElement("p",null,"Offline")))),n.a.createElement("div",{id:"expanded"},this.props.loading?n.a.createElement(_.a,{indicator:j}):this.props.isAuthenticated?n.a.createElement("button",{onClick:()=>this.props.logout(),className:"authBtn"},n.a.createElement("span",null,"Logout")):n.a.createElement("div",null,n.a.createElement("form",{method:"POST",onSubmit:this.authenticate},this.state.loginForm?n.a.createElement("div",null,n.a.createElement("input",{name:"username",type:"text",placeholder:"username"}),n.a.createElement("input",{name:"password",type:"password",placeholder:"password"})):n.a.createElement("div",null,n.a.createElement("input",{name:"username",type:"text",placeholder:"username"}),n.a.createElement("input",{name:"email",type:"email",placeholder:"email"}),n.a.createElement("input",{name:"password",type:"password",placeholder:"password"}),n.a.createElement("input",{name:"password2",type:"password",placeholder:"password confirm"})),n.a.createElement("button",{type:"submit"},"Authenticate")),n.a.createElement("button",{onClick:this.changeForm},"Switch"))))),n.a.createElement("div",{id:"search"},n.a.createElement("label",{htmlFor:""},n.a.createElement("i",{className:"fa fa-search","aria-hidden":"true"})),n.a.createElement("input",{type:"text",placeholder:"Search Chats..."})),n.a.createElement("div",{id:"contacts"},n.a.createElement("ul",null,e)),n.a.createElement("div",{id:"bottom-bar"},n.a.createElement("button",{id:"addChat",onClick:()=>this.openAddChatPopup()},n.a.createElement("i",{className:"fa fa-user-plus fa-fw","aria-hidden":"true"}),n.a.createElement("span",null,"Create chat")),n.a.createElement("button",{id:"settings"},n.a.createElement("i",{className:"fa fa-cog fa-fw","aria-hidden":"true"}),n.a.createElement("span",null,"Settings"))))}}var G=Object(l.b)(e=>({isAuthenticated:null!==e.auth.token,loading:e.auth.loading,token:e.auth.token,username:e.auth.username,chats:e.message.chats}),e=>({login:(t,a)=>e(((e,t)=>a=>{a({type:"AUTH_START"}),P.a.post("".concat(k,"/rest-auth/login/"),{username:e,password:t}).then(t=>{const s=t.data.key,n=new Date((new Date).getTime()+36e5);localStorage.setItem("token",s),localStorage.setItem("username",e),localStorage.setItem("expirationDate",n),a(I(e,s)),a(F(3600))}).catch(e=>{a(M(e))})})(t,a)),logout:()=>e(U()),signup:(t,a,s,n)=>e(((e,t,a,s)=>n=>{n({type:"AUTH_START"}),P.a.post("".concat(k,"/rest-auth/registration/"),{username:e,email:t,password1:a,password2:s}).then(t=>{const a=t.data.key,s=new Date((new Date).getTime()+36e5);localStorage.setItem("token",a),localStorage.setItem("username",e),localStorage.setItem("expirationDate",s),n(I(e,a)),n(F(3600))}).catch(e=>{n(M(e))})})(t,a,s,n)),addChat:()=>e({type:"OPEN_ADD_CHAT_POPUP"}),getUserChats:(t,a)=>e(x(t,a))}))(L),B=a(291);class W extends n.a.Component{render(){return null===this.props.token?n.a.createElement(B.a,{to:"/"}):n.a.createElement("div",{className:"contact-profile"},null!==this.props.username?n.a.createElement(C,null,n.a.createElement("img",{src:"http://emilcarlsson.se/assets/harveyspecter.png",alt:""}),n.a.createElement("p",null,this.props.username),n.a.createElement("div",{className:"social-media"},n.a.createElement("i",{className:"fa fa-facebook","aria-hidden":"true"}),n.a.createElement("i",{className:"fa fa-twitter","aria-hidden":"true"}),n.a.createElement("i",{className:"fa fa-instagram","aria-hidden":"true"}))):null)}}var J=Object(l.b)(e=>({username:e.auth.username,token:e.auth.token}))(W),V=a(289),X=a(287),z=a(288),q=a(54),K=a(293);const Q=X.a.Item;class Y extends n.a.Component{constructor(...e){super(...e),this.state={usernames:[],error:null},this.handleChange=e=>{this.setState({usernames:e})},this.handleSubmit=e=>{const{usernames:t}=this.state;e.preventDefault(),this.props.form.validateFields((e,a)=>{if(!e){const e=[...t,this.props.username];P.a.defaults.xsrfHeaderName="X-CSRFTOKEN",P.a.defaults.xsrfCookieName="csrftoken",P.a.defaults.headers={"Content-Type":"application/json",Authorization:"Token ".concat(this.props.token)},P.a.post("".concat(k,"/chat/create/"),{messages:[],participants:e}).then(e=>{this.props.history.push("/".concat(e.data.id)),this.props.closeAddChatPopup(),this.props.getUserChats(this.props.username,this.props.token)}).catch(e=>{console.error(e),this.setState({error:e})})}})}}componentDidMount(){this.props.form.validateFields()}render(){const{getFieldDecorator:e,getFieldsError:t,getFieldError:a,isFieldTouched:s}=this.props.form,r=s("userName")&&a("userName");return n.a.createElement(X.a,{layout:"inline",onSubmit:this.handleSubmit},this.state.error?"".concat(this.state.error):null,n.a.createElement(Q,{validateStatus:r?"error":"",help:r||""},e("userName",{rules:[{required:!0,message:"Please input the username of the person you want to chat with"}]})(n.a.createElement(z.a,{mode:"tags",style:{width:"100%"},placeholder:"Tags Mode",onChange:this.handleChange},[]))),n.a.createElement(Q,null,n.a.createElement(q.a,{type:"primary",htmlType:"submit",disabled:(o=t(),Object.keys(o).some(e=>o[e]))},"Start a chat")));var o}}const Z=X.a.create()(Y);var $=Object(K.a)(Object(l.b)(e=>({token:e.auth.token,username:e.auth.username}),e=>({closeAddChatPopup:()=>e({type:"CLOSE_ADD_CHAT_POPUP"}),getUserChats:(t,a)=>e(x(t,a))}))(Z));class ee extends n.a.Component{render(){return n.a.createElement(V.a,{centered:!0,footer:null,visible:this.props.isVisible,onCancel:this.props.close},n.a.createElement($,null))}}var te=ee;a(284);class ae extends n.a.Component{componentDidMount(){this.props.onTryAutoSignup()}constructor(e){super(e),y.addCallbacks(this.props.setMessages.bind(this),this.props.addMessage.bind(this))}render(){return n.a.createElement(S.a,null,n.a.createElement("div",{id:"frame"},n.a.createElement(G,null),n.a.createElement("div",{className:"content"},n.a.createElement(te,{isVisible:this.props.showAddChatPopup,close:()=>this.props.closeAddChatPopup()}),n.a.createElement(J,null),n.a.createElement(D,null))))}}var se=Object(l.b)(e=>({showAddChatPopup:e.nav.showAddChatPopup,authenticated:e.auth.token}),e=>({onTryAutoSignup:()=>e(e=>{const t=localStorage.getItem("token"),a=localStorage.getItem("username");if(void 0===t)e(U());else{const s=new Date(localStorage.getItem("expirationDate"));s<=new Date?e(U()):(e(I(a,t)),e(F((s.getTime()-(new Date).getTime())/1e3)))}}),closeAddChatPopup:()=>e({type:"CLOSE_ADD_CHAT_POPUP"}),addMessage:t=>e((e=>({type:"ADD_MESSAGE",message:e}))(t)),setMessages:t=>e((e=>({type:"SET_MESSAGES",messages:e}))(t))}))(ae);const ne=window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__||c.d;const re=function(){const e=Object(c.c)({auth:u,nav:g,message:f});return Object(c.e)(e,ne(Object(c.a)(i.a)))}(),oe=n.a.createElement(l.a,{store:re},n.a.createElement(se,null));o.a.render(oe,document.getElementById("app"))}},[[141,1,2]]]);
//# sourceMappingURL=main.d6711f99.chunk.js.map